---
title: "ã€Docker/ECR/ECSã€‘ ã‚³ãƒ³ãƒ†ãƒŠå…¥é–€ã¾ã¨ã‚â‘¢"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [AWS, Docker, ECS, ECR]
published: true
---
# å‰ç·¨
- [Docker / ECR / ECS ã‚³ãƒ³ãƒ†ãƒŠå…¥é–€ã¾ã¨ã‚â‘ ](https://qiita.com/umaibou1126/items/d4d5973feafc788e8a29)
- [Docker / ECR / ECS ã‚³ãƒ³ãƒ†ãƒŠå…¥é–€ã¾ã¨ã‚â‘¡](https://qiita.com/umaibou1126/items/8d654b219bd8e0f05524)

# å‚è€ƒæ–‡çŒ®
- [AWS CLI ã§ Amazon ECR ã« docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ push ã™ã‚‹](https://qiita.com/aokad/items/17a06c2384041bd60d16)
- [Amazon EC2 Container Service (ECS)ã‚’è©¦ã—ã¦ã¿ãŸ](https://dev.classmethod.jp/articles/ecs-ataglance/#return-note-126407-1)
- [CircleCI+ECS+ECRç’°å¢ƒã§Dockerã‚³ãƒ³ãƒ†ãƒŠã®CD(ç¶™ç¶šçš„ãƒ‡ãƒ—ãƒ­ã‚¤)ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ -å‰ç·¨-](https://dev.classmethod.jp/articles/circleci-ecr-ecs-1/)
- [CircleCI+ECS+ECRç’°å¢ƒã§Dockerã‚³ãƒ³ãƒ†ãƒŠã®CD(ç¶™ç¶šçš„ãƒ‡ãƒ—ãƒ­ã‚¤)ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ -å¾Œç·¨-](https://dev.classmethod.jp/articles/httpdev-classmethod-jpcloudcircleci-ecr-ecs-2/)

# å‰æº–å‚™

#### â—† Dockerã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```
$ sudo yum update -y

$ sudo amazon-linux-extras install docker
```

#### â—† Dockerèµ·å‹•
```
$ sudo systemctl start docker
```

#### â—† dockerã‚°ãƒ«ãƒ¼ãƒ—ã«ãƒ¦ãƒ¼ã‚¶è¿½åŠ 
```
$ sudo usermod -a -G docker ec2-user
```

#### â—† dockerã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
```
$ docker info
```

# ECRç·¨

#### â—† ECRãƒ­ã‚°ã‚¤ãƒ³
```
$ aws ecr get-login --no-include-email  â€»å‡ºåŠ›ã•ã‚Œã‚‹é•·ã„ã‚³ãƒãƒ³ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³
```

#### â—† ECRãƒªãƒã‚¸ãƒˆãƒªä½œæˆ
```
$ aws ecr create-repository --repository-name sample  â€»ãƒªãƒã‚¸ãƒˆãƒªå
```

#### â—† ç’°å¢ƒå¤‰æ•°ã‚»ãƒƒãƒˆ
```
$ export registryId=[å‡ºåŠ›ã•ã‚ŒãŸãƒ¬ã‚¸ã‚¹ãƒˆãƒªId]
$ export region=ap-northeast-1 ã€€â€»ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å
$ export imagename=sample
$ export tag=ver1
```

#### â—† Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆ
```
$ docker build -t ${imagename}:${tag} .
```

#### â—† Dockerã‚¤ãƒ¡ãƒ¼ã‚¸tagä»˜ã‘
```
$ docker tag ${imagename}:${tag} ${registryId}.dkr.ecr.${region}.amazonaws.com/${imagename}:${tag}
```

#### â—† Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥
```
$ docker push ${registryId}.dkr.ecr.${region}.amazonaws.com/${imagename}:${tag}
```


# ECSç·¨

#### â—† IAMãƒ­ãƒ¼ãƒ«ã®ä½œæˆ

- ã€ŒAmazonEC2ContainerServiceforEC2Roleã€ãƒãƒªã‚·ãƒ¼ã®ä»˜ä¸

```:ecs-role
{
  "Version": "2020-5-23",
  "Statement": [
    {
      "Action": "ecs:*",
      "Effect": "Allow",
      "Resource": "*"
    }
  ]
}
```

#### â—† ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ä½œæˆã‚³ãƒãƒ³ãƒ‰
```
$ export region=us-east-1
$ export cluster=sample-cluster
$ aws ecs create-cluster --region ${region} --cluster-name ${cluster}
$ aws ecs list-clusters --region ${region} --output json
```

#### â—† ec2ä½œæˆ
- AMIé¸æŠï¼šami-34ddbe5c
- IAMãƒ­ãƒ¼ãƒ«ï¼šä¸Šè¨˜ã®ecs-roleã‚’ä½¿ç”¨
- ãƒ¦ãƒ¼ã‚¶ãƒ‡ãƒ¼ã‚¿ï¼šä¸‹è¨˜å…¥åŠ›

```:userdata
#!/bin/bash
echo ECS_CLUSTER=[ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å] >> /etc/ecs/ecs.config
```

#### â—† ECS/EC2ç´ä»˜ã‘ç¢ºèª
```
$ aws ecs list-container-instances --cluster ${cluster} --output json --region ${region}
$ ssh ec2-user@XX.XX.XX.XX    â€»ec2ãƒ­ã‚°ã‚¤ãƒ³
$ sudo docker ps
```

#### ECSã‚¿ã‚¹ã‚¯ç™»éŒ²ãƒ»å®Ÿè¡Œ

- å‚ç…§ï¼š[Amazon EC2 Container Service (ECS)ã‚’è©¦ã—ã¦ã¿ãŸ](https://dev.classmethod.jp/articles/ecs-ataglance/#return-note-126407-1)

```
$ vim sample.json
```

```sample.json
[
  {
    "environment": [],
    "name": "sample",
    "image": "sample-image",
    "cpu": 10,
    "portMappings": [],
    "entryPoint": [
      "/bin/sh"
    ],
    "memory": 10,
    "command": [
      "sample",
      "360"
    ],
    "essential": true
  }
]
```

##### â–  ã‚¿ã‚¹ã‚¯ç™»éŒ²ã‚³ãƒãƒ³ãƒ‰
```
$ aws ecs register-task-definition --family sample --container-definitions file://sample.json --region ${region} --output json
```
##### â–  ã‚¿ã‚¹ã‚¯ç¢ºèª
```
$ aws ecs list-task-definitions --region ${region}
```

##### â–  ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰
```
$ aws ecs run-task --cluster ${cluster} --task-definition sample:1 --count 1 --region ${region} --output json
```

##### â–  ã‚¿ã‚¹ã‚¯å®Ÿè¡Œç¢ºèª
```
$ sudo docker ps
```
