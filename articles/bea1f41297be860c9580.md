---
title: "ã€Istioã€‘TLS / Authentication / Authorizationã¾ã¨ã‚"
emoji: "ğŸ•Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Kubernetes", "Istio"]]
published: true
---

# TLSè¨­å®š

### TLS Secretã‚’ç”¨ã„ãŸHTTPSè¨­å®š

```Gateway_https.yml
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: my-gateway
  namespace: default
spec:
  selector:
    istio: ingressgatewayã€€ # default istio gateway proxy
  servers:
  - port:
      number: 80  # HTTPç”¨
      name: http
      protocol: HTTP
    hosts:
    - uk.bookinfo.com  # DNSãƒ›ã‚¹ãƒˆï¼ˆHTTPç”¨ï¼‰
  - port:
      number: 443  # HTTPSç”¨
      name: https
      protocol: HTTPS
    hosts:
    - "bookinfo-namespace/*.bookinfo.com"  # HTTPS ãƒãƒ¼ãƒˆ443ç”¨DNS
    tls:
      mode: SIMPLE  # SIMPLE or MUTUAL
      credentialName: bookinfo-secret  # TLSè¨¼æ˜æ›¸
```

### SNIï¼ˆè¤‡æ•°ãƒ›ã‚¹ãƒˆã¸ã®TLSï¼‰è¨­å®š

```Gateway_https-sni.yml
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: my-gateway
  namespace: default
spec:
  selector:
    istio: ingressgatewayã€€ # default istio gateway proxy
  servers:
  - port:
      number: 80  # HTTPç”¨
      name: http
      protocol: HTTP
    hosts:
    - uk.bookinfo.com  # DNSãƒ›ã‚¹ãƒˆï¼ˆHTTPç”¨ï¼‰
  - port:
      number: 443  # HTTPSç”¨
      name: https
      protocol: HTTPS
    hosts:
    - "bookinfo-namespace/*.bookinfo.com"  # HTTPS ãƒãƒ¼ãƒˆ443ç”¨DNS
    tls:
      mode: SIMPLE  # SIMPLE or MUTUAL
      credentialName: bookinfo-secret  # TLSè¨¼æ˜æ›¸
  - port:
      number: 443  # SNIç”¨HTTPSãƒãƒ¼ãƒˆ443
      name: https-sni
      protocol: HTTPS
    hosts:
    - "bookinfo-namespace/*.bookinfo-to-sni.com"  # DNSï¼ˆSNIç”¨ï¼‰
    tls:
      mode: SIMPLE  # SIMPLE or MUTUAL
      credentialName: bookinfo-secret-to-sni # TLSè¨¼æ˜æ›¸ï¼ˆSNIç”¨ï¼‰
```

### SNIç”¨ãƒ›ã‚¹ãƒˆã‚’VirtualServiceã«è¿½åŠ 

```virtual_service_sni.yml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo-rule
  namespace: default
spec:
  hosts:
  - "bookinfo-namespace/*.bookinfo.com"  # HTTPSï¼ˆãƒ¡ã‚¤ãƒ³ç”¨ï¼‰
  - "bookinfo-namespace/*.bookinfo-to-sni.com"  # HTTPSï¼ˆSNIç”¨ï¼‰
  gateways:
  - default/my-gateway
  http:
  - match:
    - uri:
        prefix: /reviews/
    route:
    - destination:
        port:
          number: 80  # serviceãƒãƒ¼ãƒˆ
        host: reviews.prod.svc.cluster.local
```

### PeerAuthenticationï¼ˆNamespaceé™å®šï¼‰

```PeerAuthentication_namespace.yml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: default  # ç›¸äº’TLSãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®ã¿è¨±å®¹ã€€ç›¸äº’TLSã®ãŸã‚defaultã¯ãƒ–ãƒ­ãƒƒã‚¯
spec:
  mtls:
    mode: STRICT
```

### PeerAuthenticationï¼ˆWorkloadé™å®šï¼‰

```PeerAuthentication_workload.yml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: default  # ç›¸äº’TLSãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®ã¿è¨±å®¹ã€€
spec:
  selector:
    matchLabels:
      run: httpbin  # ãƒ©ãƒ™ãƒ«ï¼ˆhttpbinï¼‰ãŒã¤ã„ã¦ã„ã‚‹podã«é™å®šã•ã‚Œã‚‹
  mtls:
    mode: STRICT
```

```destinationrule_mutual_tls.yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: httpbin
spec:
  host: httpbin.default  # ãƒ›ã‚¹ãƒˆ
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL  # ç›¸äº’TLSã®ã¿è¨±å¯ã™ã‚‹
```

### HTTPã‹ã‚‰HTTPSã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

```gateway_https_redirect.yml
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: my-gateway
  namespace: some-config-namespace
spec:
  selector:
    app: my-gateway-controller
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - uk.bookinfo.com  # HTTPãƒ›ã‚¹ãƒˆ
    tls:
      httpsRedirect: true  # HTTPã‹ã‚‰HTTPSã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
```

### curl podä½œæˆ

```
$ kubectl run curl \
      --restart Never \
      --image curlimages/curl \
      -n <namespaceå> \
      --dry-run -o yaml \
      -- /bin/sh -c "sleep infinity" > curl_pod.yaml
```

### httpbin podä½œæˆ

```
$ kubectl run httpbin \
      --restart Never \
      -n <namespaceå> \
      --image docker.io/kennethreitz/httpbin
```

### httpbin podå…¬é–‹

```
kubectl expose pod httpbin --port 80 -n <namespaceå>
```

### curlå®Ÿè¡Œ

```
$ kubectl exec -it curl -n <curl podã®namespaceå> sh
$ curl httpbin.<httpbinã®namespaceå>/headers -v
```

### JWTèªè¨¼

```jwt_authentication.yml
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: "jwt-example"
  namespace: istio-system  # Istioã®root namespaceã«é©ç”¨ã™ã‚‹
spec:
  selector:
    matchLabels:
      app: ingressgateway  # IngressGatewayã«é©ç”¨
  jwtRules:  # JWTå¿…é ˆåŒ–
  - issuer: "testing@secure.istio.io"
    jwksUri: "https://raw.githubusercontent.com/istio/istio/release-1.10/security/tools/jwt/samples/jwks.json"
```

```jwt_authorization_policy.yml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: require-jwt
  namespace: istio-system  # Istioã®root namespaceã«é©ç”¨ã™ã‚‹
spec:
  selector:
    matchLabels:
      app: ingressgateway  # IngressGatewayã«é©ç”¨
  action: ALLOW
  rules:
  - from:
    - source:  # principalsãŒã‚ã‚‹å ´åˆã€JWTæœ‰åŠ¹ï¼ˆvalidï¼‰
       requestPrincipals: ["testing@secure.istio.io/testing@secure.istio.io"]
```

### JWTèªè¨¼ï¼ˆHTTP PATHé™å®šï¼‰

```jwt_authorization_policy_http_path.yml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: jwt_path
  namespace: istio-system  # Istioã®root namespaceã«é©ç”¨ã™ã‚‹
spec:
  selector:
    matchLabels:
      app: ingressgateway  # IngressGatewayã«é©ç”¨
  action: ALLOW
  rules:
  - from:
    - source:  # principalsãŒã‚ã‚‹å ´åˆã€JWTæœ‰åŠ¹ï¼ˆvalidï¼‰
       requestPrincipals: ["testing@secure.istio.io/testing@secure.istio.io"]
    to:
      - operation:
          paths: ["/headers"]  # headersã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ã€JWTèªè¨¼å¿…é ˆ
ã€€ã€€ã€€ã€€ã€€ã€€hosts: ["test.sni.com"]  # test.sni.com/headersã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯JWTèªè¨¼å¿…é ˆ
```

### HTTP header Attributeã‚’ç”¨ã„ãŸJWTèªè¨¼

```jwt_authorization_policy_http_header.yml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: jwt_path
  namespace: istio-system  # Istioã®root namespaceã«é©ç”¨ã™ã‚‹
spec:
  selector:
    matchLabels:
      app: ingressgateway  # IngressGatewayã«é©ç”¨
  action: ALLOW
  rules:
  - from:
    - source:  # principalsãŒã‚ã‚‹å ´åˆã€JWTæœ‰åŠ¹ï¼ˆvalidï¼‰
       requestPrincipals: ["testing@secure.istio.io/testing@secure.istio.io"]
    to:
      - operation:
          paths: ["/headers"]  # headersã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ã€JWTèªè¨¼å¿…é ˆ
ã€€ã€€ã€€ã€€ã€€ã€€hosts: ["test.sni.com"]  # test.sni.com/headersã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯JWTèªè¨¼å¿…é ˆ
    when:
    - key: request.headers[x-token]
      values: ["admin"]  # headerã®X-tokenãŒadminã§ã‚ã‚‹å¿…è¦ã‚ã‚Š
```

### ç‰¹å®šã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¯¾ã—ã¦ã€JWTèªè¨¼ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹

``````jwt_authorization_policy_ip.yml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: jwt_path
  namespace: istio-system  # Istioã®root namespaceã«é©ç”¨ã™ã‚‹
spec:
  selector:
    matchLabels:
      app: ingressgateway  # IngressGatewayã«é©ç”¨
  action: ALLOW
  rules:
  - from:
    - source:
       ipBlocks: ["XX.XXX.X.XX"]  # æŒ‡å®šã—ãŸIPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ã€ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯
```


### ServiceEntry

```service_entry.yml
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: external-svc-https
spec:
  hosts:
  - api.dropboxapi.com  # ServiceEntryã«é–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã‚‹ãƒ›ã‚¹ãƒˆ
  location: MESH_EXTERNAL  # ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã€Œãƒ¡ãƒƒã‚·ãƒ¥ã®å¤–éƒ¨ã¨è¦‹ãªã™ã€ã‹ã€ã€Œãƒ¡ãƒƒã‚·ãƒ¥ã®ä¸€éƒ¨ã¨è¦‹ãªã™ã€ã‹
  ports:
  - number: 443
    name: https
    protocol: TLS
  resolution: DNS  # å¿…é ˆé …ç›®
```

### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š

```virtualservice_timeout.yml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-route
spec:
  hosts:
  - reviews.prod.svc.cluster.local # k8sã®Serviceåï¼ˆvirtualservice.ymlã¨åŒã˜ï¼‰
  - mesh  # Gatewayã«é™ã‚‰ãšã€ãã‚Œãã‚Œã®Envoy Proxyã«ã‚‚ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨ã™ã‚‹
  http:
  - timeout: 1s  # 1ç§’ä»¥å†…ã«returnã—ãªã„å ´åˆã€HTTPã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹
  - route:
    - destination:
        host: reviews.prod.svc.cluster.local # k8sã®Serviceåï¼ˆvirtualservice.ymlã¨åŒã˜ï¼‰
        subset: v1 # podã«ã¤ã‘ãŸlabelï¼ˆè² è·åˆ†æ•£ç”¨ï¼‰
      weight: 25
    - destination:
        host: reviews.prod.svc.cluster.local # k8sã®Serviceåï¼ˆvirtualservice.ymlã¨åŒã˜ï¼‰
        subset: v2ã€€
      weight: 75
```

### ServiceEntry HTTPSæœ‰åŠ¹åŒ–

```service_entry_https.yml
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: external-svc-https
spec:
  hosts:
  - www.google.com  # ServiceEntryã«é–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã‚‹ãƒ›ã‚¹ãƒˆ
  location: MESH_EXTERNAL  # ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã€Œãƒ¡ãƒƒã‚·ãƒ¥ã®å¤–éƒ¨ã¨è¦‹ãªã™ã€ã‹ã€ã€Œãƒ¡ãƒƒã‚·ãƒ¥ã®ä¸€éƒ¨ã¨è¦‹ãªã™ã€ã‹
  ports:
  - number: 80
    name: http-port
    protocol: HTTP
  - number: 443
    name: https-port-for-tls-origination
    protocol: HTTPS
  resolution: DNS  # å¿…é ˆé …ç›®
```

```service_entry_destination_rule.yml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: google-com
spec:
  host: www.google.com
  subsets:
  - name: tls-origination
    trafficPolicy:
      loadBalancer:  # round robin / random / least connectionã®3æŠ
        simple: ROUND_ROBIN
      portLevelSettings:
      - port:
          number: 443
        tls:
          mode: SIMPLE  # SIMPLE or MUTUAL
```

```service_entry_virtual_service.yml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: google.com
spec:
  hosts:
  - "*.google.com"
  http:
  - match:
    - port: 80
  - route:
    - destination:
        host: www.google.com  # ServiceEntryã¨DestinationRuleã¨é–¢é€£ä»˜ã‘
        subset: tls-origination  # DestinationRuleã§å®šç¾©
        port:
          number: 443
```




# å‚è€ƒæ–‡çŒ®
 - [ç±³ã‚·ãƒªã‚³ãƒ³ãƒãƒ¬ãƒ¼DevOpsç›£ä¿®ï¼Istio Service Mesh ãƒãƒ³ã‚ºã‚ªãƒ³+Kubernetes AWS EKS](https://www.udemy.com/course/istio-service-mesh-kubernetes-aws-eks-2020-handson/)
 - [Istio Documentation](https://istio.io/latest/docs/)
