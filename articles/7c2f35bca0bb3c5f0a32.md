---
title: "ã€Terraformã€‘ ECS/IAMä½œæˆæ‰‹é †ã¾ã¨ã‚"
emoji: "ğŸŒŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [AWS, Terraform, IAM, ECS]
published: true
---
# å‚è€ƒæ–‡çŒ®
- [Terraform - CentOS 7 ã« Terraform ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ AWS ã¸æ¥ç¶š](https://qiita.com/anfangd/items/5eac63d77264e796ffb5)
- [Terraformã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](https://qiita.com/moroishisan/items/35736e9a0332d0df9206)
- [AWS Fargateã¨Terraformã§æœ€å¼·ï¼†ç°¡å˜ãªã‚¤ãƒ³ãƒ•ãƒ©ç’°å¢ƒã‚’ç›®æŒ‡ã™](https://qiita.com/tarumzu/items/2d7ed918f230fea957e8)
- [tfenvã§Terraformã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚’ã™ã‚‹](https://qiita.com/kamatama_41/items/ba59a070d8389aab7694)
- [Terraform Workspacesã®åŸºç¤ã¨ä½¿ã„æ–¹ã«ã¤ã„ã¦è€ƒãˆã¦ã¿ãŸï¼](https://dev.classmethod.jp/articles/how-to-use-terraform-workspace/)
- [Amazon ECS+Fargate ã¾ã¨ã‚ (terraformã‚’ä½¿ã£ãŸã‚¯ãƒ©ã‚¹ã‚¿æ§‹ç¯‰ã¨ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒ«ã€ãƒ–ãƒ«ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤)](https://qiita.com/marnie_ms4/items/202deb8f587233a17cca)
- [Terraformè·äººå…¥é–€: æ—¥ã€…ã®é‹ç”¨ã§å­¦ã‚“ã çŸ¥è¦‹ã‚’æ·¡ã€…ã¨ã¾ã¨ã‚ã‚‹](https://qiita.com/minamijoyo/items/1f57c62bed781ab8f4d7)
- [Terraformã§JSONã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ããŸã„ã ã‘ã®äººç”Ÿã ã£ãŸ](https://qiita.com/minamijoyo/items/18fa28132cf737c86ddf)

# Terraformã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †

#### â—† æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ç¢ºèªã€€
- https://releases.hashicorp.com/terraform/

#### â—† ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰
```
$ sudo yum install wget unzip
$ wget https://releases.hashicorp.com/terraform/0.12.25/terraform_0.12.25_linux_amd64.zip
$ sudo unzip ./terraform_0.12.25_linux_amd64.zip -d /usr/local/bin/
$ terraform -v
```

#### â—† tfenvã‚’åˆ©ç”¨ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†

- tfenvï¼šTerraformã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã«ç‰¹åŒ–ã—ãŸãƒ„ãƒ¼ãƒ«

```
//git clone ã€œ ãƒ‘ã‚¹è¨­å®š
$ git clone https://github.com/tfutils/tfenv.git ~/.tfenv
$ echo 'export PATH="$HOME/.tfenv/bin:$PATH"' >> ~/.bash_profile
$ source ~/.bash_profile

//tfenvã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ tfenv install latest
$ tfenv use latest
$ tfenv list
```

# terraformç”¨èª

|ç”¨èª      |æ„å‘³     |
|:--------|:---------------------------------------|
|State|Terraformã§ç®¡ç†ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã€‚.tfstateã®ã“ã¨|
|tf.state|ãƒ­ãƒ¼ã‚«ãƒ«ã«tfstateãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã‚‹ãŒã€S3ã§ç®¡ç†ã™ã‚‹ã®ãŒåŸºæœ¬|
|Backend|Stateã®ä¿å­˜å…ˆã€‚   â€»S3ãªã©|
|Resource|Terraformã§ç®¡ç†ã™ã‚‹å¯¾è±¡ã®åŸºæœ¬å˜ä½|
|Module|Resourceã‚’å†åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã¾ã¨ã‚ãŸTerraformã®ã‚³ãƒ¼ãƒ‰|

# åˆæœŸè¨­å®š

#### â—† terraform.tfvarså®šç¾©
```
$ cat >> ./terraform.tfvars  << FIN
access_key = "*****************"
secret_key = "*****************"
db_user = "XXXXX"
db_pass = "XXXXXXXXX"
FIN
```

#### â—† terraform workspaceä½œæˆ
```
$ terraform workspace new development
$ terraform workspace select development
```

#### â—† S3ç”¨ã®profileä½œæˆ   â€»tfstateæ ¼ç´ç”¨
```
$ aws configure --profile s3-profile
```

# main.tf
- [AWS Fargateã¨Terraformã§æœ€å¼·ï¼†ç°¡å˜ãªã‚¤ãƒ³ãƒ•ãƒ©ç’°å¢ƒã‚’ç›®æŒ‡ã™](https://qiita.com/tarumzu/items/2d7ed918f230fea957e8)

```main.tf
// å¤‰æ•°ã‚’å®šç¾©ã€€â€»terraform.tfvarså‚ç…§
variable "access_key" {}
variable "secret_key" {}
variable "token" {}
variable "db_user" {}
variable "db_pass" {}
variable "region" { default = "ap-northeast-1"}

// S3ã«tfstateã‚’æ ¼ç´
terraform {
  backend "s3" {
    bucket = "sample-project"
    key    = "sample-project.terraform.tfstate"
    region     = "ap-northeast-1"
    profile = "sample-profile"
  }
}

// ãƒ—ãƒ­ãƒã‚¤ãƒ€è¨­å®š  â€»ä¸Šè¨˜å¤‰æ•°å‚ç…§
provider "aws" {
  access_key = "${var.access_key}"
  secret_key = "${var.secret_key}"
  region     = "${var.region}"
}

// modulesã®ã‚½ãƒ¼ã‚¹ã‚’æŒ‡å®š
module "base" {
  region                            = "${var.region}"
  db_user                           = "${var.db_user}"
  db_pass                           = "${var.db_pass}"
  source = "./modules"
}
```

# ecs.tf
```ecs.tf
resource "aws_ecs_cluster" "ecs_cluster" {
  name = "sample-cluster"
}
```

# IAM Policy / IAM Roleä½œæˆ

- [Terraform](https://www.terraform.io/docs/providers/aws/d/iam_policy_document.html)

```iam.tf
data "aws_iam_policy_document" "samplepolicy" {
  statement {
    actions = [
      "s3:PutObject",
      "s3:GetObject",
    ]

    resources = [
      "arn:aws:s3:::foo-bucket/*",
    ]
  }
}

resource "aws_iam_policy" "samplepolicy" {
  name        = "samplepolicy"
  path        = "/"
  description = ""
  policy      = data.aws_iam_policy_document.samplepolicy.json
}

data "aws_iam_policy_document" "samplerole_assume_policy" {
  statement {
    actions = ["sts:AssumeRole"]

    principals {
      type        = "Service"
      identifiers = ["ecs-tasks.amazonaws.com"]
    }
  }
}

resource "aws_iam_role" "samplerole" {
  name               = "samplerole"
  assume_role_policy = data.aws_iam_policy_document.samplerole_assume_policy.json
}

resource "aws_iam_role_policy_attachment" "samplerole_attachement" {
  role       = aws_iam_role.samplerole.name
  policy_arn = aws_iam_policy.samplepolicy.arn
}
```
