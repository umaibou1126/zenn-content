---
title: ã€Dockerã€‘ECSè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ - Dockerç·¨ -
emoji: ğŸ˜¸
type: tech
topics: [Docker, Nginx, Ruby, Rails]
published: true
---
# å‚è€ƒæ–‡çŒ®
 - [[Terraform][Backends][v0.9]tfstateãƒ•ã‚¡ã‚¤ãƒ«ã®ç®¡ç†æ–¹æ³•](https://blog.adachin.me/archives/5884)
 - [ã‚°ãƒ«ãƒ¼ãƒ—ä¼šç¤¾ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ECS/Fargateã«ç§»è¡Œã—ã¦æŒ¯ã‚Šè¿”ã‚‹](https://engineer.blog.lancers.jp/2020/05/ecs-fargate-replace/)
 - [[AWS][Terraform][Fargate]ECSã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ALBé…ä¸‹ã«ç½®ã](https://blog.adachin.me/archives/11211)
 - [circleci/aws-ecs@1.4.0](https://circleci.com/developer/orbs/orb/circleci/aws-ecs)
 - [AWS ECR/ECS ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤](https://circleci.com/docs/ja/2.0/ecs-ecr/#docker-%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%81%97%E3%81%A6-aws-ecr-%E3%81%AB%E3%83%97%E3%83%83%E3%82%B7%E3%83%A5%E3%81%99%E3%82%8B)

## ãƒ„ãƒªãƒ¼å›³

```:docker/dev
â”œâ”€â”€ app
â”‚Â Â  â”œâ”€â”€ Dockerfile
â”‚Â Â  â”œâ”€â”€ nginx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.conf
â”‚Â Â  â”‚Â Â  â””â”€â”€ nginx.conf
â”‚Â Â  â””â”€â”€ supervisor
â”‚Â Â      â”œâ”€â”€ app.conf
â”‚Â Â      â””â”€â”€ supervisord.conf
â”œâ”€â”€ db
â”‚Â Â  â”œâ”€â”€ data
â”‚Â   â””â”€â”€ mysql_init
```

## Dockerã‚³ãƒãƒ³ãƒ‰

##### â—† dockerã‚³ãƒ³ãƒ†ãƒŠå‰Šé™¤
```
$ docker rm -f `docker ps -a -q`
```

##### â—† dockerã‚¤ãƒ¡ãƒ¼ã‚¸å‰Šé™¤
```
$ docker rmi `docker images -q`
```

##### â—† dockerã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆ
```
$ docker build -f docker/dev/app/Dockerfile -t sample_dev .
```

##### â—† ECRãƒ—ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰
```
$ docker tag XXXXXX sample/dev  //Docker hubãƒªãƒã‚¸ãƒˆãƒª
$ docker images
$ docker push sample/dev
$ docker tag sample/dev:latest XXXXXX.dkr.ecr.XXXXXX.amazonaws.com/ecs-sample:latest
$ docker push XXXXXX.dkr.ecr.XXXXXX.amazonaws.com/ecs-sample:latest
```

##### â—† dockerã‚³ãƒ³ãƒ†ãƒŠå†…å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰
```
$ bundle install
$ bundle exec rake db:create db:migrate

// supervisorèµ·å‹•
$ /usr/bin/supervisorctl restart app

// productionç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ
$ bundle exec rails db:migrate RAILS_ENV=production

// ã‚¢ã‚»ãƒƒãƒˆãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
$ bundle exec rake assets:precompile RAILS_ENV=production
```

##### â—† database.ymlã‚³ãƒãƒ³ãƒ‰
```
$ export RAILS_DATABASE_USERNAME=test
$ export RAILS_DATABASE_PASSWORD=password
$ export RAILS_DATABASE_HOST=rds.XXXXXX.XXXXXX.rds.amazonaws.com
$ export RAILS_DATABASE_PORT=3306
```

##### â—† nginx && pumaã‚³ãƒãƒ³ãƒ‰
```
// ãƒãƒ¼ãƒˆç¢ºèª
$ ps -ef | grep nginx
$ ps aux | grep nginx

// nginxåœæ­¢ã‚³ãƒãƒ³ãƒ‰
$ nginx -s stop

// PIDé–¢é€£ã‚³ãƒãƒ³ãƒ‰
$ touch /var/run/nginx.pid
$ touch /run/nginx.pid

// ãƒãƒ¼ãƒˆå æœ‰ç¢ºèª
$ sudo lsof -i:80
$ ps ax | grep rails

// pumaèµ·å‹•
$ bundle exec puma -C config/puma.rb
$ bundle exec pumactl start
```

##### â—† supervisorã‚³ãƒãƒ³ãƒ‰
```
// supervisorèµ·å‹•
$ /etc/init.d/supervisor start
$ supervisord -c /etc/supervisor/supervisord.conf

// supervisorã®socketã‚³ãƒãƒ³ãƒ‰
$ sudo touch /var/run/supervisor.sock
$ sudo chmod 777 /var/run/supervisor.sock
$ supervisorctl help stop

// supervisordã®è¨­å®šã®ã€Œ/var/runã€ã‚’ã€Œ/dev/shmã€ ã«å¤‰æ›´ã™ã‚‹
$ sed -i "s/\/var\/run/\/dev\/shm/g" /etc/supervisor/supervisord.conf
```


## Dockerfile

```:Dockerfile
FROM ruby:2.7.1
ENV APP_ROOT /var/www/sample_dev
ENV LANG C.UTF-8
ENV TZ Asia/Tokyo


/// ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ ///
RUN mkdir -p $APP_ROOT
RUN mkdir -p /root/tmp
WORKDIR $APP_ROOT


/// Node.jsã€Nginx, supervisorã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ///
RUN apt-get update -y && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
    bash \
    build-essential \
    git \
    libcurl4-openssl-dev \
    libghc-yaml-dev \
    libqt5webkit5-dev \
    libxml2-dev \
    libxslt-dev \
    libyaml-dev \
    linux-headers-amd64 \
    default-mysql-client \
    nginx \
    nodejs \
    openssl \
    ruby-dev \
    ruby-json \
    tzdata \
    vim \
    supervisor \
    zlib1g-dev && \
    apt-get clean -y && \
    rm -rf /var/cache/apt/archives/* /var/lib/apt/lists/*


/// supervisorç”¨logãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ ///
RUN mkdir -p /var/log/supervisor


/// nginx.conf, conf.d/app.confä½œæˆ ///
COPY app/nginx/nginx.conf /etc/nginx/nginx.conf
COPY app/nginx/app.conf /etc/nginx/conf.d/app.conf


/// supervisord.conf, conf.d/app.confä½œæˆ ///
COPY app/supervisor/supervisord.conf /etc/supervisor/supervisord.conf
COPY app/supervisor/app.conf /etc/supervisor/conf.d/app.conf


/// ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ï¼ˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ­ã‚°ï¼‰ ///

/// å„nginxã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚° ///
RUN ln -sf /dev/stdout /var/log/nginx/access.log
RUN ln -sf /dev/stdout /var/log/nginx/app.access.log
RUN ln -sf /dev/stderr /var/log/nginx/app.error.log


/// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°(pumaãƒ­ã‚°) ///
RUN ln -sf /dev/stdout $APP_ROOT/log/development.log
RUN ln -sf /dev/stdout $APP_ROOT/log/production.log


CMD [ "/usr/bin/supervisord" ]
```

## Nginx

```nginx.conf
user  root;
worker_processes  1;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;

    keepalive_timeout  65;

    include /etc/nginx/conf.d/*.conf;
}
```

```app.conf
/// ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã€ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¨­å®š ///
  access_log /var/log/nginx/access.log main;
  error_log /var/log/nginx/error.log warn;

    upstream app {
        server unix:///var/www/sample_dev/tmp/sockets/puma.sock;
    }
    server {
        listen 80;
        server_name dev.sample.com;

         /// URLã®ãƒ‘ã‚¹è¨­å®š ///
        location / {

        /// ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·è¨­å®š ///
        proxy_pass http://app;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_redirect off;
    }
}
```

## puma

```config/puma.rb
threads_count = ENV.fetch('RAILS_MAX_THREADS') { 5 }.to_i
threads threads_count, threads_count
# ãƒãƒ¼ãƒˆã‚’é–‹æ”¾ã—ã¦ãŠã‹ãªã„ã¨ã€socketã®listenãŒè¡Œã‚ã‚Œãªã„
#port        ENV.fetch('PORT') { 3000 }
environment ENV.fetch('RAILS_ENV') { 'development' }
plugin :tmp_restart

app_root = File.expand_path('../..', __FILE__)
# nginxã®httpãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§socketé€šä¿¡ã‚’è¡Œã†
bind "unix://#{app_root}/tmp/sockets/puma.sock"

stdout_redirect "#{app_root}/log/puma.stdout.log", "#{app_root}/log/puma.stderr.log", true
```


## supervisor

```supervisord.conf
/// supervisor.sockä½œæˆ ///
[unix_http_server]
file=/var/run/supervisor.sock


[supervisord]
/// nodaemon=true: supervisorãŒforground(æœ€å‰é¢)ãƒ—ãƒ­ã‚»ã‚¹ã§æŒ¯èˆã† ///
nodaemon=true


logfile=/var/log/supervisor/supervisord.log
pidfile=/var/tmp/supervisord.pid


/// rpcinterfaceã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€supervisorctlãŒæœ‰åŠ¹ã«ãªã‚‹ ///
[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface


/// supervisorctlã‚’ä½¿ã£ã¦ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ã‚’å¯èƒ½ã«ã™ã‚‹ ///
[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[include]
files = /etc/supervisor/conf.d/*.conf
```

```app.conf
[program:app]
command=bundle exec puma -C ./config/puma.rb
autostart=true
autorestart=true
stopsignal=TERM
user=root
directory=/var/www/sample_dev/
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0


[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
stopsignal=TERM
user=root
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
```




