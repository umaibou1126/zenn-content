---
title: "ã€CI/CDã€‘ Git Codedeploy é€£æºã¾ã¨ã‚"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Git, GitHub, CircleCI, CodeDeploy]
published: true
---

# å‚è€ƒæ–‡çŒ®

- [CircleCI 2.0ã¨codedeployã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è‡ªå‹•åŒ–ã™ã‚‹](https://dev.classmethod.jp/articles/deploy-with-codedeploy-circleci2-0/)
- [CircleCIã¨AWSï¼ˆCodeDeploy/S3ï¼‰ã§ä½œã‚‹CIç’°å¢ƒ](https://qiita.com/hardreggaecafe/items/7ff3ada575a1100fa4a2)
- [CodeDeployã§GitHubã®ã‚½ãƒ¼ã‚¹ã‚’EC2ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¾ã¨ã‚](https://qiita.com/saka-shin/items/b388f9c2d62a1ffadb8c)
- [CodeDeployã¨CircleCIã‚’åˆ©ç”¨ã—ãŸBlue/Greenãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ](https://dev.classmethod.jp/articles/bg-deploy-with-codedeploy-and-circleci/)
- [AWS CodeDeploy ã® AppSpec ã‚’èª­ã¿è§£ã](https://dev.classmethod.jp/articles/code-deploy-appspec/)
- [ã‚¹ãƒ†ãƒƒãƒ— 2: ã‚µãƒ³ãƒ—ãƒ«ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹](https://docs.aws.amazon.com/ja_jp/codedeploy/latest/userguide/tutorials-on-premises-instance-2-create-sample-revision.html)


# code-deploy-agentã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
$ sudo yum update
$ sudo yum install ruby
$ sudo yum install wget
$ cd /home/ec2-user
$ wget https://aws-codedeploy-ap-northeast-1.s3.amazonaws.com/latest/install
$ chmod +x ./install
$ sudo ./install auto
$ sudo service codedeploy-agent start
```

# circle.ymlã®è¨˜è¿°

##### ä¸‹è¨˜å‚ç…§â–¼
[CodeDeployã¨CircleCIã‚’åˆ©ç”¨ã—ãŸBlue/Greenãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ](https://dev.classmethod.jp/articles/bg-deploy-with-codedeploy-and-circleci/)

```circle.yml
deployment:
  blue:
    branch: release/blue
    codedeploy:
      bg-deploy-app: ã€€ã€€ã€€ã€€ã€€   #CodeDeployä½œæˆæ™‚ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å
        application_root: /app  #appspec.ymlã®ãƒ‘ã‚¹
        revision_location:
          revision_type: S3ã€€ã€€ã€€#ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã®ä¿ç®¡å ´æ‰€ï¼ˆS3ï¼‰
          s3_location:
            bucket: bg-deploy-app
            key_pattern: apps/{SHORT_COMMIT}  #S3ãƒã‚±ãƒƒãƒˆã®ã‚­ãƒ¼åæŒ‡å®š
        region: ap-northeast-1
        deployment_group: Blueã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€   #ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚°ãƒ«ãƒ¼ãƒ—å
        deployment_config: CodeDeployDefault.AllAtOnce
  green:
    branch: release/green
    codedeploy:
      bg-deploy-app:
        application_root: /app
        revision_location:
          revision_type: S3
          s3_location:
            bucket: bg-deploy-app
            key_pattern: apps/{SHORT_COMMIT}
        region: ap-northeast-1
        deployment_group: Green
        deployment_config: CodeDeployDefault.AllAtOnce
```

# appspec.ymlã®è¨˜è¿°

##### ä¸‹è¨˜å‚ç…§â–¼
[CircleCIã¨AWSï¼ˆCodeDeploy/S3ï¼‰ã§ä½œã‚‹CIç’°å¢ƒ](https://qiita.com/hardreggaecafe/items/7ff3ada575a1100fa4a2)

```appspec.yml
version: 0.0
os: linux # ã“ã®ã‚ãŸã‚Šã¯ãŠç´„æŸãªã®ã§ãã®ã¾ã¾è¨˜è¿°ã™ã‚‹ã“ã¨

files:
# You can specify one or more mappings in the files section.
  - source: /
    destination: /home/ec2-user # ä»–ãŒè‰¯ã‘ã‚Œã°äº‹å‰ã«ãƒ¦ãƒ¼ã‚¶åã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ä½œæˆã™ã‚‹ã“ã¨
hooks:
  BeforeInstall:
    - location: Scripts/BeforeInstall.sh      #ä¸‹è¨˜ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã‚·ã‚§ãƒ«å‚ç…§
  AfterInstall:
    - location: Scripts/AfterInstall.shã€€ ã€€   #ä¸‹è¨˜ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã‚·ã‚§ãƒ«å‚ç…§
      timeout: 60
  ApplicationStart:
    - location: Scripts/ApplicationStart.shã€€  #ä¸‹è¨˜ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã‚·ã‚§ãƒ«å‚ç…§
      timeout: 60
  ValidateService:
    - location: Scripts/ValidateService.shã€€   #ä¸‹è¨˜ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã‚·ã‚§ãƒ«å‚ç…§
      timeout: 60
```

# ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã‚·ã‚§ãƒ«ã®ä½œæˆã€€
##### ä¸‹è¨˜å‚ç…§â–¼
[ã‚¹ãƒ†ãƒƒãƒ— 2: ã‚µãƒ³ãƒ—ãƒ«ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹](https://docs.aws.amazon.com/ja_jp/codedeploy/latest/userguide/tutorials-on-premises-instance-2-create-sample-revision.html)

### BeforeInstall.sh

```Scripts/BeforeInstall.sh
#!/bin/bash
export FOLDER=/tmp/CodeDeployExample

if [ -d $FOLDER ]
then
 rm -rf $FOLDER
fi

mkdir -p $FOLDER
```

### AfterInstall.sh

```Scripts/AfterInstall.sh
#!/bin/bash
cd /tmp/CodeDeployExample

echo "The AfterInstall deployment lifecycle event successfully completed." > after-install.txt
```

### ApplicationStart.sh

```
#!/bin/bash
cd /tmp/CodeDeployExample

echo "The ApplicationStart deployment lifecycle event successfully completed." > application-start.txt
```

### ValidateService.sh

```
#!/bin/bash
cd /tmp/CodeDeployExample

echo "The ValidateService deployment lifecycle event successfully completed." > validate-service.txt

unset FOLDER
```

### å®Ÿè¡Œæ¨©é™ä»˜ä¸
```
$ chmod +x ./Scripts/*
```


# CircleCI CodeDeployã®é€£æº
##### ä¸‹è¨˜å‚ç…§â–¼
[CircleCI 2.0ã¨codedeployã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è‡ªå‹•åŒ–ã™ã‚‹](https://dev.classmethod.jp/articles/deploy-with-codedeploy-circleci2-0/)

```.circleci/config.yml
version: 2
jobs:
  build: #å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‚¸ãƒ§ãƒ–
    working_directory: ~/my-app
    docker:
      - image: ruby:2.4.0
    steps:
      - checkout
      - run: bundle install --path vendor/bundle
      - run:
          name: Run Test
          command: bundle exec rspec
  deploy: #ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚¸ãƒ§ãƒ–
    working_directory: ~/my-app
    docker:
    - image: ruby:2.4.0
    steps:
      - checkout
      - run: bundle install --path vendor/bundle
      - run: bundle exec rake deploy
workflows:
  version: 2
  build-deploy:
    jobs:
      - build
      - deploy: # deployã¯buildã®ã‚ã¨ã«å®Ÿè¡Œ
          requires:
            - build
          filters: # developãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
            branches:
              only: develop
```

```:Rakefile
# frozen_string_literal: true

require 'aws-sdk-codedeploy'
require 'aws-sdk-s3'

# Configs for codedeploy
APP_NAME = 'app_name'
S3_BUCKET = 'mybucket'
S3_PREFIX = 'app/versions/'
TAG = `git describe --tags`.strip
DEPLOY_GROUP_NAME = 'deploy_group_name'

desc "Deploy with codedeploy"
task :deploy do
  # upload files to s3
  zip_file = "#{APP_NAME}_#{TAG}.zip"
  s3_key = S3_PREFIX + '/' + zip_file
  `git archive HEAD --output=#{zip_file}`
  begin
    Aws::S3::Client.new.put_object(bucket: S3_BUCKET, key: s3_key, body: File.open(File.basename(zip_file)))
  ensure
    File.delete(zip_file)
  end
  # register revision
  revision = {
    revision_type: 'S3',
    s3_location: {
      bucket: S3_BUCKET,
      key: s3_key,
      bundle_type: 'zip',
    },
  }
  codedeploy = Aws::CodeDeploy::Client.new
  codedeploy.register_application_revision(application_name: APP_NAME, revision: revision)
  # deploy
  codedeploy.create_deployment(application_name: APP_NAME,
                               deployment_group_name: DEPLOY_GROUP_NAME,
                               revision: revision,
                               file_exists_behavior: 'OVERWRITE')
end
```

