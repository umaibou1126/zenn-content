---
title: "ã€Nginx+Unicornã€‘ ã‚µãƒ¼ãƒèµ·å‹•æ‰‹é †ã¾ã¨ã‚"
emoji: "ğŸ˜Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Ruby, Rails, Nginx, Unicorn]
published: true
---


# å‚è€ƒæ–‡çŒ®

##### ã“ã®è¨˜äº‹ã¯ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’å‚è€ƒã«ã—ã¦åŸ·ç­†ã—ã¾ã—ãŸ(ã‹ãªã‚ŠãŠä¸–è©±ã«ãªã‚Šã¾ã—ãŸ)

-[(ãƒ‡ãƒ—ãƒ­ã‚¤ç·¨â‘¡)ä¸–ç•Œä¸€ä¸å¯§ãªAWSè§£èª¬ã€‚EC2ã‚’åˆ©ç”¨ã—ã¦ã€Railsã‚¢ãƒ—ãƒªã‚’AWSã«ã‚ã’ã‚‹ã¾ã§](https://qiita.com/naoki_mochizuki/items/5a1757d222806cbe0cd1)

-[AWSï¼‹Nginxï¼‹Unicornã‚’åˆ©ç”¨ã—ã¦Railsã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ãŸã€‚ã€œãã®ï¼‘ã€œ](https://qiita.com/President_Taka/items/b18234b8db4cda97a113)

-[Unicornè¨­å®šã®ã¾ã¨ã‚] (https://qiita.com/syou007/items/555062cc96dd0b08a610)

# Unicornè¨­å®š

##### Unicorn.rbã¯ã€"è‡ªåˆ†ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³/config"ç›´ä¸‹ã«é…ç½®

```unicorn.rb

$worker  = 2
  $timeout = 30
  $app_dir = "/var/www/XXXXXXâ€ #ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å
  $listen  = File.expand_path 'tmp/sockets/.unicorn.sock', $app_dir
  $pid     = File.expand_path 'tmp/pids/unicorn.pid', $app_dir
  $std_log = File.expand_path 'log/unicorn.log', $app_dir
  # set config
  worker_processes  $worker
  working_directory $app_dir
  stderr_path $std_log
  stdout_path $std_log
  timeout $timeout
  listen  $listen
  pid $pid
  # loading booster
  preload_app true
  # before starting processes
  before_fork do |server, worker|
    defined?(ActiveRecord::Base) and ActiveRecord::Base.connection.disconnect!
    old_pid = "#{server.config[:pid]}.oldbin"
    if old_pid != server.pid
      begin
        Process.kill "QUIT", File.read(old_pid).to_i
      rescue Errno::ENOENT, Errno::ESRCH
      end
    end
  end
  # after finishing processes
  after_fork do |server, worker|
    defined?(ActiveRecord::Base) and ActiveRecord::Base.establish_connection
  end

```

### Unicornèµ·å‹•ã‚³ãƒãƒ³ãƒ‰

```
$ bundle exec unicorn_rails -c config/unicorn.rb
```

### Unicornèµ·å‹•ç¢ºèª

```
$ ps -ef | grep unicorn | grep -v grep
```

### Unicornåœæ­¢ã‚³ãƒãƒ³ãƒ‰

```
$ kill -QUIT `cat /path/to/unicorn.pid`
```


# Nginxè¨­å®š

##### " etc/nginx/nginx.conf "ã§è¨­å®š

```
$ sudo vi /etc/nginx/nginx.conf
```

```nginx.conf

user  nginx;
    worker_processes  1;
â€‹
    error_log  /var/log/nginx/error.log warn;
    pid        /var/run/nginx.pid;
â€‹
â€‹
    events {
        worker_connections  1024;
    }
â€‹
    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;
â€‹
        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';
â€‹
        access_log  /var/log/nginx/access.log  main;
â€‹
        sendfile        on;
        #tcp_nopush     on;
â€‹
        keepalive_timeout  65;
â€‹
        #gzip  on;
â€‹
        # include /etc/nginx/conf.d/*.conf;
â€‹
        upstream unicorn {
        server unix:/var/www/XXXXXXX/tmp/sockets/unicorn.sock;  #ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å
        }
    server {
          listen 3000;
          server_name XXXXXXXX;ã€€ï¼ƒIPã‚¢ãƒ‰ãƒ¬ã‚¹
          access_log /var/log/nginx/app_access.log;
          error_log /var/log/nginx/app_error.log;
          try_files $uri/index.html @unicorn;
â€‹
          root home/ec2-user/var/www/XXXXXXX/public; #ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å
          client_max_body_size 15M;
          client_body_temp_path /tmp/client_body;
â€‹
          location @unicorn {
            proxy_pass http://unicorn;
          }
â€‹
          location ~ ^/assets/ {
            root /var/www/XXXXXXXX/public;  #ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å
          }
          error_page 404 /404.html;
            location = /40x.html {
          }
          error_page 500 502 503 504 /50x.html;
            location = /50x.html {
          }
      }
    }
```

### Nginxèµ·å‹•ã‚³ãƒãƒ³ãƒ‰

```
$ sudo systemctl start nginx.service
```

### Nginxèµ·å‹•ç¢ºèª

```
$ sudo systemctl status nginx.service
```

### Nginxåœæ­¢ã‚³ãƒãƒ³ãƒ‰

```
$ sudo systemctl stop nginx.service
```

