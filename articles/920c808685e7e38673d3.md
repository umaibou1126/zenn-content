---
title: "ãƒ¢ã‚¹ã‚¯ãƒ¯ã®å¤©æ°—ã«è©³ã—ã„å½¼å¥³botãŒæ¬²ã—ã„"
emoji: "ğŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Go, Heroku, LINE, LINE Bot, å€‹äººé–‹ç™º]
published: true
---


# ã¯ã˜ã‚ã«

ãƒ¢ã‚¹ã‚¯ãƒ¯ã®å¤©æ°—ã«ç²¾é€šã—ãŸ**å½¼å¥³é¢¨LINE BOT**ã‚’ä½œæˆã—ã¾ã—ãŸ

[![Image from Gyazo](https://i.gyazo.com/c78a840ad1fe0201b3b649766a4e7a04.png)](https://gyazo.com/c78a840ad1fe0201b3b649766a4e7a04)

#### QRã‚³ãƒ¼ãƒ‰

[![Image from Gyazo](https://i.gyazo.com/f22a26304e7bc0755cd4f4a95b1d2cd2.png)](https://gyazo.com/f22a26304e7bc0755cd4f4a95b1d2cd2)

#### ä½¿ç”¨æŠ€è¡“
 - Go
 - line-bot-sdk
 - heroku
 - [openWeather API](https://openweathermap.org/)

# äº‹å‰æº–å‚™
LINE BOT ä½œæˆæ‰‹é †ã¯ã€ä»¥ä¸‹è¨˜äº‹ã«ã¾ã¨ã‚ã¾ã—ãŸã®ã§ã€å‚è€ƒã«ã—ã¦é ‚ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚
[LINE BOTã§å½¼å¥³botã‚’ä½œã‚ŠãŸã„](https://qiita.com/umaibou1126/items/f1a00c1311f6f2dc0114)

# ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ ä½œæˆ

#### [LINE Official Account Manager](https://account.line.biz/login?redirectUri=https%3A%2F%2Fmanager.line.biz%2F%3Fstatus%3Dsuccess) ãƒ­ã‚°ã‚¤ãƒ³

#### ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆåé¸æŠã€ > ã€Œãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ç®¡ç†ã€ > ã€Œãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ é¸æŠ

[![Image from Gyazo](https://i.gyazo.com/2e0075892f6e13d93ab03534a44b0add.png)](https://gyazo.com/2e0075892f6e13d93ab03534a44b0add)

#### ã€Œä½œæˆã€ > ã€Œã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¨­å®šã€ > ã€Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠã€ > ã€Œç”»åƒã‚’ä½œæˆã€

[![Image from Gyazo](https://i.gyazo.com/128c0a3297fad8a8cf0b24e00d8e4b9e.png)](https://gyazo.com/128c0a3297fad8a8cf0b24e00d8e4b9e)

#### ä»»æ„ã®ç”»åƒãƒ»ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šã—ã€å³ä¸Šã®ã€Œé©ç”¨ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

[![Image from Gyazo](https://i.gyazo.com/b7ecaee4b1c98d4dbf7674664ff67e7f.png)](https://gyazo.com/b7ecaee4b1c98d4dbf7674664ff67e7f)

#### ã€Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ ã§ã€Œãƒ†ã‚­ã‚¹ãƒˆã€ã‚’é¸æŠã—ã€ä»»æ„ã®æ–‡å­—ã‚’è¨­å®š > å³ä¸Šã®ã€Œä¿å­˜ã€ã§å®Œäº†

[![Image from Gyazo](https://i.gyazo.com/11322d60079be878e42e612a77ea6703.png)](https://gyazo.com/11322d60079be878e42e612a77ea6703)


# openWeather API è¨­å®š

#### [openWeather API](https://openweathermap.org/) > API Key å–å¾—

[![Image from Gyazo](https://i.gyazo.com/cea6f6f9adb5007a454c111898d14c3b.png)](https://gyazo.com/cea6f6f9adb5007a454c111898d14c3b)

# Botä½œæˆ

#### Goãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæº–å‚™

```
$ mkdir sample-bot && cd sample-bot
$ go mod init github.com/GitHubãƒ¦ãƒ¼ã‚¶å/GitHubãƒªãƒã‚¸ãƒˆãƒªå
```

#### Goãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
$ go get github.com/line/line-bot-sdk-go/linebot
$ go get github.com/gin-gonic/gin
```

#### ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

```main.go
package main

import (
	"encoding/json"
	"fmt"
	"io/ioutil"
	"log"
	"net/http"
	"os"
	"strings"

	"github.com/gin-gonic/gin"
	"github.com/line/line-bot-sdk-go/linebot"
)

type Wdata struct {
	Weather []Weather `json:"weather"`
	Info    Info      `json:"main"`
}

type Weather struct {
	Main string `json:"main"`
	Icon string `json:"icon"`
}

type Info struct {
	Temp     float32 `json:"temp"`
	Humidity float32 `json:"humidity"`
}

func main() {
	port := os.Getenv("PORT")

	if port == "" {
		log.Fatal("$PORT must be set")
	}
	bot, err := linebot.New(
		"LINE ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ",
		"LINE ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³",
	)
	if err != nil {
		log.Fatal(err)
	}

	router := gin.New()
	router.Use(gin.Logger())

	// LINE Messaging API ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
	router.POST("/callback", func(c *gin.Context) {
		events, err := bot.ParseRequest(c.Request)
		if err != nil {
			if err == linebot.ErrInvalidSignature {
				log.Print(err)
			}
			return
		}

		// ãƒ¢ã‚¹ã‚¯ãƒ¯
		var moskwaWeather string
		moskwaWeather = "ãƒ¢ã‚¹ã‚¯ãƒ¯"

		for _, event := range events {
			// ã‚¤ãƒ™ãƒ³ãƒˆãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å—ä¿¡ã ã£ãŸå ´åˆ
			if event.Type == linebot.EventTypeMessage {
				switch message := event.Message.(type) {
				// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã®å ´åˆ
				case *linebot.TextMessage:
					replyMessage := message.Text
					// ãƒ¢ã‚¹ã‚¯ãƒ¯
					if strings.Contains(replyMessage, moskwaWeather) {
						moskwasWeather(bot, event)
					}
					// ä¸Šè¨˜æ„å¤–ã¯ã€ãŠã†ã‚€è¿”ã—ã§è¿”ä¿¡
					_, err = bot.ReplyMessage(event.ReplyToken, linebot.NewTextMessage(replyMessage)).Do()
					if err != nil {
						log.Print(err)
					}
				}
			}
		}
	})
	router.Run(":" + port)
}

// ãƒ¢ã‚¹ã‚¯ãƒ¯
func moskwasWeather(bot *linebot.Client, e *linebot.Event) {
	lat := "55.7558" // ãƒ¢ã‚¹ã‚¯ãƒ¯ã®ç·¯åº¦
	lon := "37.6173" // ãƒ¢ã‚¹ã‚¯ãƒ¯ã®çµŒåº¦
	u := "http://api.openweathermap.org/data/2.5/weather?lat=" + lat + "&lon=" + lon + "&APPID=XXXXXXXXXX" // openWeatherï¼šAPI Keyã‚’è¨­å®š
	//å¤©æ°—æƒ…å ±ã‚’å–å¾—
	resp, err := http.Get(u)
	if err != nil {
		log.Fatal(err)
	}
	defer resp.Body.Close()
	byteArray, _ := ioutil.ReadAll(resp.Body)
	jsonBytes := ([]byte)(string(byteArray[:]))
	if err != nil {
		log.Fatal(err)
	}

	wdata := new(Wdata)
	if err := json.Unmarshal(jsonBytes, wdata); err != nil {
		fmt.Println("JSON Unmarshal error:", err)
		return
	}
	var resWeather string
	resWeather = fmt.Sprintf(wdata.Weather[0].Main)

	// æ—¥æœ¬èªå¤‰æ›
	if resWeather == "Clouds" {
		resWeather = "æ›‡ã‚Š"
	} else if resWeather == "Clear" {
		resWeather = "æ™´ã‚Œ"
	} else if resWeather == "Rain" {
		resWeather = "é›¨"
	} else if resWeather == "Drizzle" {
		resWeather = "éœ§é›¨"
	} else if resWeather == "Thunderstorm" {
		resWeather = "é›·é›¨"
	} else if resWeather == "Snow" {
		resWeather = "é›ª"
	}

	var temp string
	temp = fmt.Sprintf("%.2f", (wdata.Info.Temp - 273.15))
	var humidity string
	humidity = fmt.Sprintf("%.2f", wdata.Info.Humidity)
	var res string
	res = fmt.Sprintf("å¤©æ°—ï¼š%s\næ°—æ¸©ï¼š%sâ„ƒ\næ¹¿åº¦ï¼š%sï¼…", resWeather, temp, humidity)

	_, err = bot.ReplyMessage(e.ReplyToken, linebot.NewTextMessage(res)).Do()
	if err != nil {
		log.Fatal(err)
	}
}
```

# å‚è€ƒæ–‡çŒ®

 - [LINE BOT APIã§ç°¡å˜BOTä½œæˆ](https://ceblog.mediba.jp/post/150169029917/line-bot-api%E3%81%A7%E7%B0%A1%E5%8D%98bot%E8%A3%BD%E4%BD%9C)
 - [ã€åˆå­¦è€…å‘ã‘ã€‘Go,LINEBot,AWSLambdaã§å¤©æ°—äºˆå ±ã®ãƒœãƒƒãƒˆã‚’ä½œæˆï¼](https://qiita.com/shinya_1004/items/fb73172feb693b57605c)
 - [æ¯æœ å¤©æ°—ã‚’é€šçŸ¥ã™ã‚‹ LINE Bot ã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚](http://takagusu.hateblo.jp/entry/2017/01/24/200453)
 - [ç„¡æ–™å¤©æ°—äºˆå ±APIã®OpenWeatherMapã‚’ä½¿ã£ã¦ã¿ã‚‹](https://qiita.com/nownabe/items/aeac1ce0977be963a740)
