---
title: "ã€Docker/ECR/ECSã€‘ ã‚³ãƒ³ãƒ†ãƒŠå…¥é–€ã¾ã¨ã‚â‘¡"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [AWS, Docker, ECR, ECS]
published: true
---
# å‰å¾Œç·¨
- [Docker / ECR / ECS ã‚³ãƒ³ãƒ†ãƒŠå…¥é–€ã¾ã¨ã‚â‘ ](https://qiita.com/umaibou1126/items/d4d5973feafc788e8a29)
- [Docker / ECR / ECS ã‚³ãƒ³ãƒ†ãƒŠå…¥é–€ã¾ã¨ã‚â‘¢](https://qiita.com/umaibou1126/items/aee02db86c9ae9ea7359)

#å‚è€ƒæ–‡çŒ®
- [ã€AWSã€‘åˆã‚ã¦ã®ECR](https://qiita.com/3utama/items/b19e2239edb6996a735f)
- [ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ—ãƒƒã‚·ãƒ¥](https://docs.aws.amazon.com/ja_jp/AmazonECR/latest/userguide/docker-push-ecr-image.html)
- [AWS CLI ã®è¨­å®š](https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/cli-chap-configure.html)
- [æ—¢å­˜ã®Railsã‚¢ãƒ—ãƒªã«Dockerã‚’å°å…¥ã™ã‚‹æ‰‹é †](https://qiita.com/kenzoukenzou104809/items/b9e716204e0cd0cea447)
- [æ—¢å­˜ã®railsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’Dockerã§é–‹ç™ºã™ã‚‹æ‰‹é †](https://qiita.com/kkyouhei/items/653760627bf9d4bc9e71)
- [Debianã®dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã§mysql-clientãŒç„¡ãã¦ãƒãƒã£ãŸäººã¸](https://qiita.com/henrich/items/1b7ee2f3a72f8bb29cba)
- [Dockerfile è¨˜è¿°ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](https://matsuand.github.io/docs.docker.jp.onthefly/develop/develop-images/dockerfile_best-practices/)
- [database.yml ã®ç®¡ç†æ–¹æ³•ã„ã‚ã„ã‚](https://www.techscore.com/blog/2012/10/26/how-to-manage-database-yml/)

# 1. Dockerfile

### â—† mysql-clientå•é¡Œ

- Debian10 "buster"(Ubuntuã®æ¯ã‚‰ã—ã„)ã§ã¯ã€"mysql-client"ã¯å­˜åœ¨ã—ãªã„
- "default-mysql-client"ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

```:Dockerfile
FROM ruby:2.6.5    â€»Gemfileã®Rubyãƒãƒ¼ã‚¸ãƒ§ãƒ³è¦ç¢ºèª
RUN apt-get update && apt-get install -y nodejs --no-install-recommends && rm -rf /var/lib/apt/lists/*
RUN apt-get update && apt-get install -y default-mysql-client --no-install-recommends && rm -rf /var/lib/apt/lists/*
RUN apt-get update -qq && apt-get install -y build-essential libpq-dev nodejs
RUN mkdir /app   â€»ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å
WORKDIR /app
ADD Gemfile /app/Gemfile
ADD Gemfile.lock /app/Gemfile.lock
RUN bundle install
ADD . /app
```




# 2. docker-compose.yml
### â—† ãƒ“ãƒ«ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã¤ã„ã¦
- docker buildå®Ÿè¡Œæ™‚ã®"ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª"ã‚’æŒ‡å®šã™ã‚‹
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€DockerfileãŒ"ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª"ã¨èªè­˜ã•ã‚Œã‚‹

```docker-compose.yml
version: '2'
services:
  db:
    image: mysql:latest
    environment:
      MYSQL_DATABASE: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å
      MYSQL_ROOT_PASSWORD: XXXXXXX
      MYSQL_USER: ãƒ¦ãƒ¼ã‚¶å
      MYSQL_PASSWORD: XXXXXXX
    ports:
      - "3306:3306"
  web:
    build:
      context: .
      dockerfile: Dockerfile
    command: bundle exec rails s -p 3000 -b '0.0.0.0'
    tty: true
    stdin_open: true
    depends_on:
      - db
    ports:
      - "3000:3000"
    volumes:ã€€ã€€
      - .:/app   â€»ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å
 ```

# 3. database.yml
### â—† ç’°å¢ƒå¤‰æ•°ã«ã¤ã„ã¦
```
 password: <%= ENV['DOCKER_DATABASE_PASSWORD'] %>
```
```
$ export DOCKER_DATABASE_PASSWORD=password  â€»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
```


### database.yml
```database.yml
default: &default
  adapter: mysql2
  encoding: utf8
  pool: 5
  host: db

development:
  <<: *default
  username: ãƒ¦ãƒ¼ã‚¶å
  password: XXXXXXX
  database: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å

production:
  <<: *default
  database: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å
  username: ãƒ¦ãƒ¼ã‚¶å
  password: <%= ENV['DOCKER_DATABASE_PASSWORD'] %>
```








# 4. ECRãƒ—ãƒƒã‚·ãƒ¥ä½œæ¥­

### AWS CLIè¨­å®š    â€»AWSãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«"ãƒã‚¤ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è³‡æ ¼æƒ…å ±"å‚ç…§
```
$ aws configure --profile ecr
AWS Access Key ID [None]: ***********************
AWS Secret Access Key [None]: *************************
Default region name [None]: ap-northeast-1
Default output format [None]: json
```

### ECRãƒ­ã‚°ã‚¤ãƒ³ã‚³ãƒãƒ³ãƒ‰
```
$ aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin ***.ecr.ap-northeast-1.amazonaws.com
```

### ã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆ
```
$ docker build -t ã€ã‚¤ãƒ¡ãƒ¼ã‚¸åã€‘ .
```

### ã‚¿ã‚°ä»˜ã‘
```
$ docker tag ã‚¤ãƒ¡ãƒ¼ã‚¸å:ã‚¿ã‚°å ***.dkr.ecr.ap-northeast-1.amazonaws.com/ã‚¤ãƒ¡ãƒ¼ã‚¸å:ã‚¿ã‚°å
```

### ãƒ—ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰
```
$ docker push ***.dkr.ecr.ap-northeast-1.amazonaws.com/ã‚¤ãƒ¡ãƒ¼ã‚¸å:ã‚¿ã‚°å
```
